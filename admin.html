<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrar Carta - Cafeter√≠a</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="js/utils.js"></script>
  <script src="js/data.js"></script>
  <style>
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .admin-card {
      background: linear-gradient(135deg, #fdf2f8, #fce7f3);
      border: 2px solid #f9a8d4;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(190, 24, 93, 0.1);
    }

    .admin-card h3 {
      color: #be185d;
      margin-bottom: 1rem;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: #be185d;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .opciones-container {
      border: 1px solid #f9a8d4;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
      background: rgba(249, 168, 212, 0.1);
    }

    .opcion-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .btn-small {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      border-radius: 15px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-danger {
      background: linear-gradient(135deg, #fecaca, #f87171);
      color: #991b1b;
    }

    .btn-success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }

    .productos-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #f9a8d4;
      border-radius: 10px;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.5);
    }

    .producto-item {
      background: rgba(249, 168, 212, 0.2);
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: between;
      align-items: center;
      gap: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #fdf2f8, #fce7f3);
      border: 2px solid #f9a8d4;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 15px rgba(190, 24, 93, 0.08);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #be185d;
      margin-bottom: 0.3rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #be185d;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }

      .opcion-item {
        flex-direction: column;
        align-items: stretch;
      }

      .opcion-item input {
        margin-bottom: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="coffee-decoration">üõ†Ô∏è</div>
    <h1>Administrar Carta</h1>
    <p style="text-align: center; font-size: 1.1rem; color: #be185d; margin-bottom: 2rem; background: linear-gradient(135deg, #fdf2f8, #fce7f3); padding: 1rem; border-radius: 15px; border: 1px solid #f9a8d4; box-shadow: 0 2px 10px rgba(190, 24, 93, 0.05);">
      ‚ú® Gestiona los productos de tu cafeter√≠a de manera din√°mica
    </p>

    <!-- Estad√≠sticas -->
    <div class="stats-grid" id="estadisticas"></div>

    <!-- Acciones principales -->
    <div class="admin-grid">
      <!-- Agregar producto -->
      <div class="admin-card">
        <h3>‚ûï Agregar Producto</h3>
        <form id="formAgregarProducto">
          <div class="form-group">
            <label for="nombre">Nombre del producto:</label>
            <input type="text" id="nombre" required placeholder="Ej: Caf√© Americano">
          </div>

          <div class="form-group">
            <label for="categoria">Categor√≠a:</label>
            <select id="categoria" required>
              <option value="">Seleccionar categor√≠a</option>
            </select>
            <input type="text" id="nuevaCategoria" placeholder="O escribe una nueva categor√≠a" style="margin-top: 0.5rem;">
          </div>

          <div class="form-group">
            <label for="icono">Icono (emoji):</label>
            <input type="text" id="icono" placeholder="üå∏" maxlength="2">
          </div>

          <div class="form-group">
            <label>Opciones de tama√±o y precio:</label>
            <div class="opciones-container" id="opcionesContainer">
              <div class="opcion-item">
                <input type="text" placeholder="Tama√±o (ej: 8 oz)" class="tama√±o-input" required>
                <input type="number" step="0.1" min="0" placeholder="Precio" class="precio-input" required>
                <button type="button" class="btn-small btn-danger" onclick="eliminarOpcion(this)">‚ùå</button>
              </div>
            </div>
            <button type="button" onclick="agregarOpcion()" class="btn-small btn-success" style="margin-top: 0.5rem;">‚ûï Agregar opci√≥n</button>
          </div>

          <button type="submit" style="width: 100%; margin-top: 1rem;">Agregar Producto</button>
        </form>
      </div>

      <!-- Gestionar productos existentes -->
      <div class="admin-card">
        <h3>üìù Gestionar Productos</h3>
        <div style="margin-bottom: 1rem;">
          <input type="text" id="buscarProducto" placeholder="üîç Buscar producto..." onkeyup="filtrarProductos(this.value)" style="width: 100%;">
        </div>
        <div class="productos-list" id="productosLista"></div>
      </div>

      <!-- Importar/Exportar -->
      <div class="admin-card">
        <h3>üíæ Importar/Exportar</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <button onclick="exportarCarta()" style="background: linear-gradient(135deg, #a7f3d0, #34d399); color: #065f46;">
            üì• Exportar Carta
          </button>

          <div></div>
            <label for="archivoImportar" style="display: block; margin-bottom: 0.5rem;">Importar carta desde archivo JSON:</label>
            <input type="file" id="archivoImportar" accept=".json" style="width: 100%; margin-bottom: 0.5rem;">
            <button onclick="importarCartaArchivo()" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #92400e;">
              üì§ Importar Carta
            </button>
          </div>

          <button onclick="restaurarCartaOriginal()" style="background: linear-gradient(135deg, #fecaca, #f87171); color: #991b1b;">
            üîÑ Restaurar Carta Original
          </button>
        </div>
      </div>
    </div>

    <!-- Volver al inicio -->
    <div style="text-align: center; margin-top: 2rem;">
      <a href="index.html" style="background: linear-gradient(135deg, #f9a8d4, #be185d); color: white; padding: 0.8rem 1.5rem; border-radius: 25px; text-decoration: none; font-weight: 600;">
        ‚Üê Volver al Inicio
      </a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      cargarEstadisticas();
      cargarCategorias();
      cargarProductosLista();
    });

    function cargarEstadisticas() {
      const carta = obtenerCarta();
      const categorias = obtenerCategorias();
      const totalProductos = carta.length;
      const totalCategorias = categorias.length;

      let totalOpciones = 0;
      carta.forEach(producto => {
        totalOpciones += producto.opciones.length;
      });

      const estadisticasContainer = document.getElementById('estadisticas');
      estadisticasContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${totalProductos}</div>
          <div class="stat-label">Productos</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${totalCategorias}</div>
          <div class="stat-label">Categor√≠as</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${totalOpciones}</div>
          <div class="stat-label">Opciones</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">S/. ${calcularPrecioPromedio().toFixed(1)}</div>
          <div class="stat-label">Precio Promedio</div>
        </div>
      `;
    }

    function calcularPrecioPromedio() {
      const carta = obtenerCarta();
      let totalPrecios = 0;
      let totalOpciones = 0;

      carta.forEach(producto => {
        producto.opciones.forEach(opcion => {
          totalPrecios += opcion.precio;
          totalOpciones++;
        });
      });

      return totalOpciones > 0 ? totalPrecios / totalOpciones : 0;
    }

    function cargarCategorias() {
      const categorias = obtenerCategorias();
      const selectCategoria = document.getElementById('categoria');

      selectCategoria.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
      categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        selectCategoria.appendChild(option);
      });
    }

    function cargarProductosLista() {
      const carta = obtenerCarta();
      const lista = document.getElementById('productosLista');

      lista.innerHTML = '';
      carta.forEach((producto, index) => {
        const div = document.createElement('div');
        div.className = 'producto-item';
        div.innerHTML = `
          <div style="flex: 1;">
            <strong>${producto.icono || 'üå∏'} ${producto.nombre}</strong>
            <br>
            <small style="color: #be185d;">${producto.categoria} ‚Ä¢ ${producto.opciones.length} opciones</small>
          </div>
          <div style="display: flex; gap: 0.3rem;">
            <button class="btn-small btn-success" onclick="editarProducto(${index})" title="Editar">‚úèÔ∏è</button>
            <button class="btn-small btn-danger" onclick="eliminarProductoConfirm('${producto.nombre}')" title="Eliminar">üóëÔ∏è</button>
          </div>
        `;
        lista.appendChild(div);
      });
    }

    function agregarOpcion() {
      const container = document.getElementById('opcionesContainer');
      const opcionDiv = document.createElement('div');
      opcionDiv.className = 'opcion-item';
      opcionDiv.innerHTML = `
        <input type="text" placeholder="Tama√±o (ej: 12 oz)" class="tama√±o-input" required>
        <input type="number" step="0.1" min="0" placeholder="Precio" class="precio-input" required>
        <button type="button" class="btn-small btn-danger" onclick="eliminarOpcion(this)">‚ùå</button>
      `;
      container.appendChild(opcionDiv);
    }

    function eliminarOpcion(button) {
      const container = document.getElementById('opcionesContainer');
      if (container.children.length > 1) {
        button.parentNode.remove();
      } else {
        alert('Debe haber al menos una opci√≥n de tama√±o y precio.');
      }
    }

    document.getElementById('formAgregarProducto').addEventListener('submit', (e) => {
      e.preventDefault();

      const nombre = document.getElementById('nombre').value.trim();
      const categoriaSelect = document.getElementById('categoria').value;
      const nuevaCategoria = document.getElementById('nuevaCategoria').value.trim();
      const icono = document.getElementById('icono').value.trim() || 'üå∏';

      const categoria = nuevaCategoria || categoriaSelect;

      if (!categoria) {
        alert('Por favor selecciona o escribe una categor√≠a.');
        return;
      }

      // Recoger opciones
      const opciones = [];
      const tama√±oInputs = document.querySelectorAll('.tama√±o-input');
      const precioInputs = document.querySelectorAll('.precio-input');

      for (let i = 0; i < tama√±oInputs.length; i++) {
        const tama√±o = tama√±oInputs[i].value.trim();
        const precio = parseFloat(precioInputs[i].value);

        if (tama√±o && precio > 0) {
          opciones.push({ tama√±o, precio });
        }
      }

      if (opciones.length === 0) {
        alert('Debe agregar al menos una opci√≥n v√°lida de tama√±o y precio.');
        return;
      }

      const nuevoProducto = {
        nombre,
        categoria,
        icono,
        opciones
      };

      try {
        agregarProducto(nuevoProducto);
        alert('‚úÖ Producto agregado exitosamente!');

        // Limpiar formulario
        document.getElementById('formAgregarProducto').reset();
        document.getElementById('opcionesContainer').innerHTML = `
          <div class="opcion-item">
            <input type="text" placeholder="Tama√±o (ej: 8 oz)" class="tama√±o-input" required>
            <input type="number" step="0.1" min="0" placeholder="Precio" class="precio-input" required>
            <button type="button" class="btn-small btn-danger" onclick="eliminarOpcion(this)">‚ùå</button>
          </div>
        `;

        // Recargar listas
        cargarEstadisticas();
        cargarCategorias();
        cargarProductosLista();

      } catch (error) {
        alert('‚ùå Error al agregar producto: ' + error.message);
      }
    });

    function eliminarProductoConfirm(nombreProducto) {
      if (confirm(`¬øEst√°s seguro de eliminar "${nombreProducto}"?`)) {
        try {
          eliminarProducto(nombreProducto);
          alert('‚úÖ Producto eliminado exitosamente!');
          cargarEstadisticas();
          cargarCategorias();
          cargarProductosLista();
        } catch (error) {
          alert('‚ùå Error al eliminar producto: ' + error.message);
        }
      }
    }

    function editarProducto(index) {
      const carta = obtenerCarta();
      const producto = carta[index];

      // Llenar formulario con datos del producto
      document.getElementById('nombre').value = producto.nombre;
      document.getElementById('categoria').value = producto.categoria;
      document.getElementById('icono').value = producto.icono || '';

      // Llenar opciones
      const container = document.getElementById('opcionesContainer');
      container.innerHTML = '';

      producto.opciones.forEach(opcion => {
        const opcionDiv = document.createElement('div');
        opcionDiv.className = 'opcion-item';
        opcionDiv.innerHTML = `
          <input type="text" placeholder="Tama√±o" class="tama√±o-input" value="${opcion.tama√±o}" required>
          <input type="number" step="0.1" min="0" placeholder="Precio" class="precio-input" value="${opcion.precio}" required>
          <button type="button" class="btn-small btn-danger" onclick="eliminarOpcion(this)">‚ùå</button>
        `;
        container.appendChild(opcionDiv);
      });

      // Cambiar comportamiento del formulario temporalmente
      const form = document.getElementById('formAgregarProducto');
      const btnSubmit = form.querySelector('button[type="submit"]');
      const originalText = btnSubmit.textContent;
      btnSubmit.textContent = 'Actualizar Producto';

      // Eliminar producto anterior al actualizar
      const handleUpdate = (e) => {
        e.preventDefault();
        eliminarProducto(producto.nombre);
        form.removeEventListener('submit', handleUpdate);
        btnSubmit.textContent = originalText;
        form.dispatchEvent(new Event('submit'));
      };

      form.addEventListener('submit', handleUpdate);

      // Scroll al formulario
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function filtrarProductos(termino) {
      const productos = document.querySelectorAll('.producto-item');
      const terminoLower = termino.toLowerCase();

      productos.forEach(producto => {
        const texto = producto.textContent.toLowerCase();
        if (texto.includes(terminoLower)) {
          producto.style.display = 'flex';
        } else {
          producto.style.display = 'none';
        }
      });
    }

    function importarCartaArchivo() {
      const archivo = document.getElementById('archivoImportar').files[0];
      if (!archivo) {
        alert('Por favor selecciona un archivo JSON.');
        return;
      }

      importarCarta(archivo)
        .then(cartaImportada => {
          alert(`‚úÖ Carta importada exitosamente! ${cartaImportada.length} productos cargados.`);
          cargarEstadisticas();
          cargarCategorias();
          cargarProductosLista();
        })
        .catch(error => {
          alert('‚ùå Error al importar carta: ' + error.message);
        });
    }

    function restaurarCartaOriginal() {
      if (confirm('¬øEst√°s seguro de restaurar la carta original? Se perder√°n todos los cambios personalizados.')) {
        try {
          const cartaRestaurada = restaurarCartaOriginal();
          alert('‚úÖ Carta original restaurada exitosamente!');
          cargarEstadisticas();
          cargarCategorias();
          cargarProductosLista();
        } catch (error) {
          alert('‚ùå Error al restaurar carta: ' + error.message);
        }
      }
    }
  </script>
</body>
</html>
